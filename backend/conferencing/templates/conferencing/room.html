<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Video Call Room</title>
    <script src="https://cdn.agora.io/sdk/release/AgoraRTC_N-4.19.0.js?nocache=202503162"></script>
    <style>
        #video_container { display: flex; flex-wrap: wrap; gap: 10px; }
        #video_container div { border: 1px solid #ccc; }
    </style>
</head>
<body>
    <h1>Video Call Room: {{ room_name }}</h1>
    <div id="video_container"></div>
    <button id="joinBtn">Join Room</button>
    <button id="leaveBtn" disabled>Leave Room</button>

    <script>
        const APP_ID = '71fbf1e2263a49869725faa8404523ec';
        let client;
        let localTracks = [];
        let remoteUsers = {};

        document.addEventListener('DOMContentLoaded', () => {
            console.log("Agora SDK Version:", AgoraRTC.VERSION);

            const joinBtn = document.getElementById('joinBtn');
            const leaveBtn = document.getElementById('leaveBtn');
            const videoContainer = document.getElementById('video_container');

            const stopLocalTracks = () => {
                localTracks.forEach(track => track.stop());
                localTracks = [];
            };

            const fetchToken = async (roomName) => {
                const response = await fetch(`/get_token/?channelName=${roomName}`);
                return await response.json();
            };

            const getStats = async () => {
                try {
                    if (localTracks.length > 0) {
                        const stats = client.getLocalVideoStats();
                        console.log("Local Video Stats:", stats);
                    } else {
                        console.log("No local tracks to get stats for.");
                    }
                } catch (error) {
                    console.error("Error getting stats:", error);
                }
            };

            joinBtn.onclick = async () => {
                try {
                    const roomName = "{{ room_name }}";
                    if (!roomName || roomName.trim() === "") {
                        alert("Room name is missing!");
                        return;
                    }

                    const data = await fetchToken(roomName);
                    if (data.error) throw new Error(data.error);

                    const token = data.token;
                    const uid = data.uid;

                    client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });

                    client.on('user-published', handleUserPublished);
                    client.on('user-unpublished', handleUserUnpublished);
                    client.on('network-quality', (stats) => {
                        console.log("Uplink quality:", stats.uplinkNetworkQuality);
                        console.log("Downlink quality:", stats.downlinkNetworkQuality);
                    });

                    console.log("Joining channel...");
                    await client.join(APP_ID, roomName, token, uid);
                    console.log("Channel joined with UID:", uid);

                    console.log("Creating Agora video track...");
                    let localTrack;
                    try {
                        localTrack = await AgoraRTC.createCameraVideoTrack({
                            encoderConfig: {
                                width: 640,
                                height: 480,
                                frameRate: 15,
                                bitrateMin: 300,
                                bitrateMax: 500,
                            }
                        });
                        console.log("Local track created:", localTrack);
                        const mediaStreamTrack = localTrack.getMediaStreamTrack();
                        console.log("Track readyState:", mediaStreamTrack.readyState);
                        console.log("Track enabled:", mediaStreamTrack.enabled);
                        console.log("Track muted:", localTrack.muted);
                    } catch (trackError) {
                        console.error("Failed to create video track:", trackError);
                        alert("Camera access failed. Joining without video.");
                        localTrack = null;
                    }

                    if (localTrack) {
                        const mediaStreamTrack = localTrack.getMediaStreamTrack();
                        if (mediaStreamTrack.readyState !== "live") {
                            console.warn("Video track is not live. ReadyState:", mediaStreamTrack.readyState);
                            alert("Video track is not live. Joining without video.");
                            localTrack = null;
                        }
                    }

                    if (localTrack) {
                        localTracks.push(localTrack);
                        const localPlayer = document.createElement("div");
                        localPlayer.id = `user-${uid}`;
                        localPlayer.style.width = "400px";
                        localPlayer.style.height = "300px";
                        videoContainer.appendChild(localPlayer);
                        console.log("Playing local track...");
                        localTrack.play(localPlayer);
                        console.log("Local track playing");

                        console.log("Publishing track...");
                        await client.publish(localTracks);
                        console.log("Track published successfully");
                    } else {
                        console.log("No video track to publish. Joined without video.");
                    }

                    getStats();

                    joinBtn.disabled = true;
                    leaveBtn.disabled = false;
                } catch (err) {
                    console.error("Failed to join room:", err);
                }
            };

            const handleUserPublished = async (user, mediaType) => {
                await client.subscribe(user, mediaType);
                if (mediaType === "video") {
                    const remotePlayer = document.createElement("div");
                    remotePlayer.id = `user-${user.uid}`;
                    remotePlayer.style.width = "400px";
                    remotePlayer.style.height = "300px";
                    videoContainer.appendChild(remotePlayer);
                    user.videoTrack.play(remotePlayer);
                    remoteUsers[user.uid] = user;
                }
            };

            const handleUserUnpublished = user => {
                const remotePlayer = document.getElementById(`user-${user.uid}`);
                if (remotePlayer) remotePlayer.remove();
                delete remoteUsers[user.uid];
            };

            leaveBtn.onclick = async () => {
                stopLocalTracks();
                await client.leave();
                videoContainer.innerHTML = '';
                remoteUsers = {};
                joinBtn.disabled = false;
                leaveBtn.disabled = true;
            };
        });
    </script>
</body>
</html>