<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Video Call Room</title>
    <script src="https://cdn.agora.io/sdk/release/AgoraRTC_N-4.8.0.js"></script>
    <style>
        #video_container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        #video_container div {
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>
    <h1>Video Call Room: {{ room_name }}</h1>
    <div id="video_container"></div>
    <button id="joinBtn">Join Room</button>
    <button id="leaveBtn" disabled>Leave Room</button>

    <script>
        const APP_ID = 'YOUR_AGORA_APP_ID'; // Replace with your Agora App ID
        let client;
        let localTracks = [];
        let remoteUsers = {};

        document.addEventListener('DOMContentLoaded', () => {
            const joinBtn = document.getElementById('joinBtn');
            const leaveBtn = document.getElementById('leaveBtn');
            const videoContainer = document.getElementById('video_container');

            // Function to stop all local tracks
            const stopLocalTracks = () => {
                localTracks.forEach(track => track.stop());
                localTracks = [];
            };

            // Function to fetch token from server
            const fetchToken = async (roomName) => {
                const response = await fetch(`/get_token/?channelName=${roomName}`);
                return await response.json();
            };

            const getStats = async (track) => {
    try {
        if (track instanceof MediaStreamTrack) {
            const stats = await client.getStats(track);
            console.log("Track Stats:", stats);
        } else {
            console.error("Invalid MediaStreamTrack:", track);
        }
    } catch (error) {
        console.error("Error getting stats:", error);
    }
};
            // Join Room Logic
            joinBtn.onclick = async () => {
                try {
                    const roomName = "{{ room_name }}";
                    if (!roomName || roomName.trim() === "") {
                        alert("Room name is missing!");
                        return;
                    }

                    const data = await fetchToken(roomName);

                    if (data.error) {
                        throw new Error(data.error);
                    }

                    const token = data.token;
                    const uid = data.uid;

                    client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });

                    client.on('user-published', handleUserPublished);
                    client.on('user-unpublished', handleUserUnpublished);

                    await client.join(APP_ID, roomName, token, uid);

                    // Create and display local video
                    const localTrack = await AgoraRTC.createCameraVideoTrack();
                    localTracks.push(localTrack);

                    const localPlayer = document.createElement("div");
                    localPlayer.id = `user-${uid}`;
                    localPlayer.style.width = "400px";
                    localPlayer.style.height = "300px";
                    videoContainer.appendChild(localPlayer);
                    localTrack.play(localPlayer);

                    await client.publish(localTracks);

                    joinBtn.disabled = true;
                    leaveBtn.disabled = false;

                } catch (err) {
                    console.error("Failed to join room:", err);
                }
            };

            // Handle Remote Users
            const handleUserPublished = async (user, mediaType) => {
                await client.subscribe(user, mediaType);
                if (mediaType === "video") {
                    const remotePlayer = document.createElement("div");
                    remotePlayer.id = `user-${user.uid}`;
                    remotePlayer.style.width = "400px";
                    remotePlayer.style.height = "300px";
                    videoContainer.appendChild(remotePlayer);

                    // Ensure the remote video track is played
                    user.videoTrack.play(remotePlayer);
                    remoteUsers[user.uid] = user;
                }
            };

            const handleUserUnpublished = user => {
                const remotePlayer = document.getElementById(`user-${user.uid}`);
                if (remotePlayer) remotePlayer.remove();
                delete remoteUsers[user.uid];
            };

            // Leave Room Logic
            leaveBtn.onclick = async () => {
                stopLocalTracks();
                await client.leave();
                videoContainer.innerHTML = '';
                remoteUsers = {};

                joinBtn.disabled = false;
                leaveBtn.disabled = true;
            };
        });
    </script>
</body>
</html>
